# 系统架构 - 高可用

### 宏观思路

- 冗余：备份，集群，负载均衡，弹性
- 分治：读写分离，分库分表（分片、sharding）
- 容错：隔离，超时，重试，熔断，限流，降级
- 监控：应用监控（日志，JVM），链路监控，实例监控（物理机），安全监控，早发现早预防

### SLA 指标

SLA（Service-Level Agreement）是一种服务承诺

- 可用性（几个9）：99.9% 指的是一天当中系统服务将会有大约86秒的服务间断期
- 延迟：TP99 = P99 = 99线，表示在100个请求里面有99个请求的响应时间会少于1秒，而剩下的1个请求响应时间会大于1秒
- 准确性：导致系统产生内部错误的有效请求数 / 期间的有效请求总数
- 系统容量：QPS(Query) = RPS(Request)

## 集群（Cluster）

- 降低成本
- 提高性能，可靠性，可扩展性（灵活性）
- 核心技术：任务调度（负载均衡）


### 负载均衡

- 算法：轮询（Round Robin）+ 加权，随机（Random）+ 加权，源地址哈希，最小连接数
- HAProxy

## 容错

- 熔断, 降级：Hystrix
- 隔离：线程，线程池
- 超时，重试：Feign
- 限流：Sentinel

## 监控

意义：提供一种反馈

### 解决方案
- Nagios
- Zabbix

### 链路监控 + APM

#### CAT
- 定位：实时应用监控平台
- 研发团队：美团
- 埋点方式：代码埋点（拦截器，注解，过滤器等）
- 颗粒度：代码
- 不符合 CNCF OpenTracing 标准
- 采集数据：
  * 系统层：cpu,mem,disk,load
  * 应用层：JVM,链路,web调用,方法代码执行次数耗时
  * 业务层：KPI数据，手动埋点
- 消息传输：Netty
- 存储：MySQL，HDFS，本地文件

#### Zipkin
- 定位：分布式追踪系统
- 研发团队：Twitter
- 埋点方式：HTTP 拦截器
- 颗粒度：接口
- 符合 CNCF OpenTracing 标准
- 采集数据：
  * 应用层：链路,接口执行次数耗时
- 消息传输：HTTP 消息队列
- 存储：MySQL，ES，Cassandra

#### SkyWalking

- 定位：分布式追踪系统, 应用性能监控系统（APM）
- 研发团队：吴晟, Apache
- 埋点方式：Java 探针，字节码增强
- 颗粒度：方法
- 符合 CNCF OpenTracing 标准
- 采集数据：
  * 系统层：cpu，mem，disk
  * 应用层：JVM，链路，方法执行次数耗时
- 消息传输：gRPC
- 存储：MySQL，ES，H2，TiDB，ShardingSphere

#### Pinpoint

- 定位：分布式追踪系统, 应用性能监控系统（APM）
- 研发团队：韩国 Naver 团队
- 埋点方式：Java 探针，字节码增强
- 颗粒度：方法
- 符合 CNCF OpenTracing 标准
- 采集数据：
  * 系统层：cpu，mem，disk
  * 应用层：JVM，链路，方法执行次数耗时
- 消息传输：Thrift
- 存储：HBase


### 监控系统

- 采集
- 存储
- 展示
- 报警

## HA 实例

### MySQL

### Eureka

### Redis
- 模式：主从复制，哨兵模式，集群模式

### RabbitMQ

### RocketMQ

### Kafka

### InfluxDB

### Prometheus

### ElasticSearch


## 常见问题

- [雪崩](https://en.wikipedia.org/wiki/Cascading_failure)
